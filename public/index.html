<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¶–ê–†–°</title>
  <link rel="stylesheet" href="style/main.css" />
</head>
<body>

  <aside class="sidebar">
    <div class="sidebar-header">
      <h2>–¶–ê–†–°</h2>
    </div>
    <nav class="sidebar-nav">
      <ul>
        <li><a href="/">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
        <li><a href="/bpla.html">–ü—Ä–æ—à–∏–≤–∫–∏ –∏ –î–∞–º–ø—ã</a></li>
        </ul>
    </nav>
    <div class="sidebar-footer">
      <div class="user-info">
        üë§ <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
        <span id="userRole">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
      </div>
      <a href="#" id="logoutBtn" class="logout-button">–í—ã–π—Ç–∏</a>
    </div>
  </aside>

<main class="content">
  <h1>–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</h1>
  <div id="statisticsContainer" class="statistics-container">
  </div>
  <button id="openModalBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ä—Ç</button>
  <div id="bplaTabs" class="tabs-container"></div>
  <div id="bplaSubTabs" class="sub-tabs-container"></div>
  <details class="filter-box">
    <summary>üîç –§–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫</summary>
    <form id="filterForm" class="filter-form">
      <div class="filter-controls">
        <div class="primary-filters">
          <label>–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞:
            <input type="text" id="numberFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä..." />
          </label>
          <label>–ü–ö:
            <select id="controllerFilter"></select>
          </label>
        </div>

        <fieldset class="checkbox-fieldset">
          <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
          <div class="checkbox-group">
            <label><input type="checkbox" id="tractionFilter" /> –¢—è–≥–∏</label>
            <label><input type="checkbox" id="angleFilter" /> –£–≥–ª—ã</label>
            <label><input type="checkbox" id="accelerationFilter" /> –ì–∞–∑</label>
            <label><input type="checkbox" id="osdFilter" /> OSD</label>
            <label><input type="checkbox" id="osdConfiguredFilter" /> –ü—Ä–æ—à–∏–≤–∫–∞ OSD</label>
            <label><input type="checkbox" id="plugsFilter" /> –°–≤–µ—á–∏</label>
            <label><input type="checkbox" id="engineStartFilter" /> –û–±–∫–∞—Ç–∫–∞</label>
          </div>
        </fieldset>
        
        <div class="date-range">
          <label>–°: <input type="date" id="dateFrom" /></label>
          <label>–ü–æ: <input type="date" id="dateTo" /></label>
        </div>
      </div>

      <div class="filter-actions">
        <button type="button" id="resetFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button type="button" id="exportBtn">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </form>
  </details>


  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <div class="table-container">
  <table>
    <thead>
      <tr>
        <th style="width: 70px;">–§–æ—Ç–æ</th>
        <th style="width: 80px;">–ù–æ–º–µ—Ä</th>
        <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
        <th style="width: 120px;">–ü–ö</th>
        <th>–¢—è–≥–∏</th>
        <th>–£–≥–ª—ã</th>
        <th>–ì–∞–∑</th>
        <th>OSD</th>
        <th>–í–∏–¥–µ–æ OSD</th>
        <th>–°–≤–µ—á–∏</th>
        <th>–û–±–∫–∞—Ç–∫–∞</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th style="width: 110px;">–î–∞—Ç–∞ —Å–æ–∑–¥.</th>
        <th>–î–µ–π—Å—Ç–≤–∏—è</th> </tr>
    </thead>
    <tbody id="boardTable"></tbody>
  </table>
</div>


  
  <!-- –ú–æ–¥–∞–ª–∫–∞ -->
<div id="addModal">
  <div class="modal-content">
    <h3>–î–æ–±–∞–≤–∏—Ç—å/–ò–∑–º–µ–Ω–∏—Ç—å –±–æ—Ä—Ç</h3>
    <form id="boardForm">
      
      <div class="form-grid">
        <label for="bplaId">–¢–∏–ø –±–æ—Ä—Ç–∞:</label>
        <select id="bplaId" required></select>

        <label for="number">–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞:</label>
        <input type="text" id="number" placeholder="–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞" required />
        <label for="supplierId">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
        <select id="supplierId"></select>
        <label for="controllerId">–ü–ö:</label>
        <select id="controllerId"></select>
      </div>

      <fieldset class="params-fieldset">
        <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="traction_date" /> –¢—è–≥–∏</label>
          <input type="date" id="traction_date" class="param-date-input" />
        </div>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="angle_date" /> –£–≥–ª—ã</label>
          <input type="date" id="angle_date" class="param-date-input" />
        </div>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="acceleration_date" /> –ì–∞–∑</label>
          <input type="date" id="acceleration_date" class="param-date-input" />
        </div>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="osd_date" /> OSD</label>
          <input type="date" id="osd_date" class="param-date-input" />
        </div>
        <div class="param-group">
            <label><input type="checkbox" data-date-target="osd_configured_date" /> –í–∏–¥–µ–æ OSD</label>
            <input type="date" id="osd_configured_date" class="param-date-input" />
        </div>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="plugs_date" /> –°–≤–µ—á–∏</label>
          <input type="date" id="plugs_date" class="param-date-input" />
        </div>
        <div class="param-group">
          <label><input type="checkbox" data-date-target="engine_start_date" /> –û–±–∫–∞—Ç–∫–∞</label>
          <input type="date" id="engine_start_date" class="param-date-input" />
        </div>
      </fieldset>

      <label for="description">–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ):</label>
      <input type="text" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
      
      <label for="photo">–§–æ—Ç–æ:</label>
      <input type="file" id="photo" accept="image/*" />

      <div class="actions">
        <button type="button" id="closeModalBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
        <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
      </div>
    </form>
  </div>
</div>

  <!-- Zoom –æ–∫–Ω–æ -->
  <div id="zoomContainer" class="zoom-img" style="display: none;" onclick="this.style.display='none'">
    <img id="zoomedImg" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–æ" />
  </div>
</main>
  <script>
  document.addEventListener("DOMContentLoaded", () => {
    // --- 1. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
    let bplaData = [];
    let editBoardId = null;
    let currentMainTabId = null;
    let currentSubTabId = null;

    const form = document.getElementById('boardForm');
    const tableBody = document.getElementById('boardTable');
    const addModal = document.getElementById('addModal');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const tabsContainer = document.getElementById('bplaTabs');
    const subTabsContainer = document.getElementById('bplaSubTabs');

    // --- 2. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–∞–Ω–Ω—ã–º–∏ –∏ API ---

    async function loadFilteredBoards() {
      const filters = getFilters();
      filters.bpla_id = currentSubTabId !== null ? currentSubTabId : currentMainTabId;

      try {
        const res = await fetch('/api/boards/filter', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(filters)
        });
        if (!res.ok) throw new Error(`–û—à–∏–±–∫–∞ —Å–µ—Ç–∏: ${res.status}`);
        const boards = await res.json();
        renderTable(boards);
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', error);
        tableBody.innerHTML = `<tr><td colspan="14" style="text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
      }
    }

    function getFilters() {
      return {
        number: document.getElementById('numberFilter').value.trim(),
        controller_id: document.getElementById('controllerFilter').value || null,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value,
        // --- –î–û–ë–ê–í–¨–¢–ï –≠–¢–£ –°–¢–†–û–ö–£ ---
        engine_start: document.getElementById('engineStartFilter').checked
      };
    }

    async function loadAndDisplayStatistics() {
      const container = document.getElementById('statisticsContainer');
      if (!container) return;
      try {
        const res = await fetch('/api/statistics');
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        const stats = await res.json();
        if (stats.length === 0) {
          container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
          return;
        }
        let html = '';
        stats.forEach(typeStat => {
          html += `
            <div class="stat-item">
              <div class="stat-title">–í—Å–µ–≥–æ "${typeStat.name}": ${typeStat.total_count}</div>
              <div class="stat-values">
                <span class="finished">‚úÖ –ì–æ—Ç–æ–≤—ã–µ: ${typeStat.finished_count}</span>
                <span class="semi-finished">üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ: ${typeStat.semi_finished_count}</span>
              </div>
            </div>`;
        });
        container.innerHTML = html;
      } catch (error) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:", error);
        container.innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>';
      }
    }

    async function loadControllers() {
      const res = await fetch('/api/controllers');
      const controllers = await res.json();
      const select = document.getElementById('controllerId');
      select.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
      controllers.forEach(ctrl => {
        const option = document.createElement('option');
        option.value = ctrl.id;
        option.textContent = `${ctrl.name} (${ctrl.dump})`;
        select.appendChild(option);
      });
    }

    async function loadControllerFilters() {
      const res = await fetch('/api/controllers');
      const controllers = await res.json();
      const select = document.getElementById('controllerFilter');
      select.innerHTML = '<option value="">–õ—é–±–æ–π</option>';
      controllers.forEach(ctrl => {
        const option = document.createElement('option');
        option.value = ctrl.id;
        option.textContent = `${ctrl.name} (${ctrl.dump})`;
        select.appendChild(option);
      });
    }

    async function loadSuppliers() {
      const select = document.getElementById('supplierId');
      // –£–±–µ–¥–∏–º—Å—è, —á—Ç–æ —ç–ª–µ–º–µ–Ω—Ç —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–µ–∂–¥–µ —á–µ–º —Å –Ω–∏–º —Ä–∞–±–æ—Ç–∞—Ç—å
      if (!select) return; 

      select.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
      try {
        const res = await fetch('/api/suppliers');
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        
        const suppliers = await res.json();
        suppliers.forEach(s => {
          const option = document.createElement('option');
          option.value = s.id;
          option.textContent = s.name;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤:', error);
        select.innerHTML = '<option value="">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</option>';
      }
    }

    async function updateBoardParameter(boardId, parameter, date) {
        try {
            const res = await fetch(`/api/board/${boardId}/parameter`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parameter, date })
            });
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±–Ω–æ–≤–∏—Ç—å –ø–∞—Ä–∞–º–µ—Ç—Ä');
            return true;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ. –û–±–Ω–æ–≤–∏—Ç–µ —Å—Ç—Ä–∞–Ω–∏—Ü—É.');
            return false;
        }
    }

    // –î–µ–ª–∞–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≥–ª–æ–±–∞–ª—å–Ω—ã–º–∏, —á—Ç–æ–±—ã onclick –≤ HTML –º–æ–≥ –∏—Ö –Ω–∞–π—Ç–∏
    window.editBoard = async function(id) {
        try {
            const res = await fetch('/api/board/' + id);
            if (!res.ok) throw new Error('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ä—Ç–∞');
            const board = await res.json();

            form.reset(); // –°–±—Ä–∞—Å—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –ø–µ—Ä–µ–¥ –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ–º
            document.querySelectorAll('.param-date-input').forEach(input => input.classList.remove('visible'));

            document.getElementById('number').value = board.number;
            document.getElementById('description').value = board.description || '';
            document.getElementById('bplaId').value = board.bpla_id;
            document.getElementById('supplierId').value = board.supplier_id || '';
            document.getElementById('controllerId').value = board.controller_id || '';

            const formatDateForInput = (date) => date ? new Date(date).toLocaleDateString('sv-SE') : '';

            // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: —Ç–µ–ø–µ—Ä—å –º—ã –∏—â–µ–º –ø–æ data-–∞—Ç—Ä–∏–±—É—Ç—É
            document.querySelectorAll('input[type="checkbox"][data-date-target]').forEach(checkbox => {
                const dateKey = checkbox.dataset.dateTarget; // –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –∫–ª—é—á, –Ω–∞–ø—Ä–∏–º–µ—Ä "traction_date"
                const dateInput = document.getElementById(dateKey);
                
                checkbox.checked = !!board[dateKey]; // –°—Ç–∞–≤–∏–º –≥–∞–ª–æ—á–∫—É, –µ—Å–ª–∏ –¥–∞—Ç–∞ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
                if (checkbox.checked) {
                    dateInput.value = formatDateForInput(board[dateKey]);
                    dateInput.classList.add('visible');
                }
            });
            
            editBoardId = id;
            addModal.style.display = 'flex';
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
        }
    }

    window.deleteBoard = async function(id) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–æ—Ä—Ç?')) return;
      await fetch('/api/board/' + id, { method: 'DELETE' });
      loadFilteredBoards();
      loadAndDisplayStatistics();
    }
    
    window.zoomImage = function(img) {
        document.getElementById('zoomedImg').src = img.src;
        document.getElementById('zoomContainer').style.display = 'flex';
    }

    async function exportToExcel() {
        const exportButton = document.getElementById('exportBtn');
        const originalText = exportButton.innerHTML;
        
        const filters = getFilters();
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –ò—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
        filters.bpla_id = currentSubTabId !== null ? currentSubTabId : currentMainTabId;

        exportButton.disabled = true;
        exportButton.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

        try {
            const res = await fetch('/api/boards/export', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(filters)
            });

            if (!res.ok) {
                throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞');
            }

            const blob = await res.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.style.display = 'none';
            a.href = url;
            a.download = `bpla_export_${new Date().toLocaleDateString('sv-SE')}.xlsx`;
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            a.remove();
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.');
        } finally {
            exportButton.disabled = false;
            exportButton.innerHTML = originalText;
        }
    }

    async function loadBplaTypesForModal() {
      const select = document.getElementById('bplaId');
      select.innerHTML = '';
      const res = await fetch('/api/bpla');
      const bplaTypes = await res.json();
      bplaTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = type.name;
        select.appendChild(option);
      });
    }

    // --- 3. –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ UI ---

    function renderTable(boards) {
        tableBody.innerHTML = '';
        if (!boards.length) {
            tableBody.innerHTML = `<tr><td colspan="14" style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            return;
        }
        const formatDate = (date) => date ? new Date(date).toLocaleDateString('ru-RU') : '';

        boards.forEach(board => {
            const tr = document.createElement('tr');
            const imgSrc = board.photo_path ? `images/${board.photo_path}` : 'https://placehold.co/60x40?text=No+Img';

            const parameters = [
                'traction_date', 'angle_date', 'acceleration_date', 'osd_date', 
                'osd_configured_date', 'plugs_date', 'engine_start_date'
            ];
            
            let paramsHtml = '';
            parameters.forEach(param => {
                const hasDate = !!board[param];
                paramsHtml += `
                    <td class="parameter-cell">
                        <input type="checkbox" class="table-param-checkbox" 
                              data-board-id="${board.id}" 
                              data-param-name="${param}" 
                              ${hasDate ? 'checked' : ''}>
                        <div class="param-date-display" id="date-${board.id}-${param}">
                            ${formatDate(board[param])}
                        </div>
                    </td>
                `;
            });

            tr.innerHTML = `
                <td><img src="${imgSrc}" onerror="this.src='https://placehold.co/60x40?text=Error'" onclick="zoomImage(this)"></td>
                <td>${board.number}</td>
                <td>${board.supplier_name || 'N/A'}</td>
                <td>${board.controller_name || 'N/A'}</td>
                ${paramsHtml}
                <td>${board.description || ''}</td>
                <td>${formatDate(board.sold_date)}</td>
                <td><button onclick="editBoard(${board.id})">‚úèÔ∏è</button></td>
                <td><button onclick="deleteBoard(${board.id})">üóë</button></td>
            `;
            tableBody.appendChild(tr);
        });
    }

    // --- 4. –õ–æ–≥–∏–∫–∞ –≤–∫–ª–∞–¥–æ–∫ ---

    function createTab(text, id, isActive = false, isSubTab = false) {
      const button = document.createElement('button');
      button.className = isSubTab ? 'sub-tab-btn' : 'tab-btn';
      if (isActive) button.classList.add('active');
      button.textContent = text;
      if (id !== null) button.dataset.bplaId = String(id);
      return button;
    }

    function setActiveTab(container, activeTab) {
      if (!container || !activeTab) return;
      container.querySelectorAll('.active').forEach(tab => tab.classList.remove('active'));
      activeTab.classList.add('active');
    }

    function handleMainTabClick(bplaId, clickedTab) {
      currentMainTabId = bplaId;
      setActiveTab(tabsContainer, clickedTab);
      renderSubTabs(bplaId);
      loadFilteredBoards();
    }

    function handleSubTabClick(bplaId, clickedSubTab) {
      currentSubTabId = bplaId;
      setActiveTab(subTabsContainer, clickedSubTab);
      loadFilteredBoards();
    }

    function renderSubTabs(parentId) {
        if (parentId === null) {
            subTabsContainer.innerHTML = '';
            subTabsContainer.style.display = 'none';
            currentSubTabId = null;
            return;
        }

        subTabsContainer.innerHTML = '';
        const children = bplaData.filter(b => b.parent_id === parentId);

        if (children.length > 0) {
            // –£–ª—É—á—à–∞–µ–º –Ω–∞–∑–≤–∞–Ω–∏–µ –≤–∫–ª–∞–¥–∫–∏ "–í—Å–µ" –¥–ª—è –ø–æ–¥–∫–∞—Ç–µ–≥–æ—Ä–∏–π
            const parentName = bplaData.find(b => b.id === parentId)?.name || '';
            const allSubTab = createTab(`–í—Å–µ ${parentName}`, parentId, true, true);
            
            allSubTab.onclick = () => handleSubTabClick(parentId, allSubTab);
            subTabsContainer.appendChild(allSubTab);

            children.forEach(child => {
                const subTab = createTab(child.name, child.id, false, true);
                subTab.onclick = () => handleSubTabClick(child.id, subTab);
                subTabsContainer.appendChild(subTab);
            });

            setActiveTab(subTabsContainer, allSubTab);
            subTabsContainer.style.display = 'flex';
            currentSubTabId = parentId;
        } else {
            subTabsContainer.style.display = 'none';
            currentSubTabId = null;
        }
    }

    async function initializeTabs() {
      try {
        const res = await fetch('/api/bpla');
        bplaData = await res.json();
        tabsContainer.innerHTML = '';
        const allTab = createTab('–í—Å–µ', null, true);
        allTab.onclick = () => handleMainTabClick(null, allTab);
        tabsContainer.appendChild(allTab);
        bplaData.filter(b => !b.parent_id).forEach(bpla => {
          const tab = createTab(bpla.name, bpla.id);
          tab.onclick = () => handleMainTabClick(bpla.id, tab);
          tabsContainer.appendChild(tab);
        });
        handleMainTabClick(null, allTab);
      } catch (error) {
        console.error("–û—à–∏–±–∫–∞ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ –≤–∫–ª–∞–¥–æ–∫:", error);
      }
    }

    // --- 5. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–æ–≤ —Å–æ–±—ã—Ç–∏–π ---
    
    openModalBtn.onclick = () => {
        form.reset();
        document.querySelectorAll('.param-date-input').forEach(input => input.classList.remove('visible'));
        editBoardId = null;
        
        // –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê: –∏—Å–ø–æ–ª—å–∑—É–µ–º –ø—Ä–∞–≤–∏–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –¥–ª—è –≤–∫–ª–∞–¥–æ–∫
        if (currentSubTabId && currentSubTabId !== currentMainTabId) {
            document.getElementById('bplaId').value = currentSubTabId;
        } else if (currentMainTabId) {
            document.getElementById('bplaId').value = currentMainTabId;
        }
        
        addModal.style.display = 'flex'; // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –º–æ–¥–∞–ª—å–Ω–æ–µ –æ–∫–Ω–æ
    };

    closeModalBtn.onclick = () => addModal.style.display = 'none';
    window.onclick = e => {  if (e.target === addModal) addModal.style.display = 'none'; };
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—É—é –æ—Ç–ø—Ä–∞–≤–∫—É —Ñ–æ—Ä–º—ã

      // --- –ò–ó–ú–ï–ù–ï–ù–û ---
      // –°–æ–±–∏—Ä–∞–µ–º –¥–∞–Ω–Ω—ã–µ –¢–û–õ–¨–ö–û –∏–∑ –ø–æ–ª–µ–π —Å –¥–∞—Ç–∞–º–∏, –∫–∞–∫ –∏ –¥–æ–≥–æ–≤–∞—Ä–∏–≤–∞–ª–∏—Å—å.
      const body = {
          bpla_id: document.getElementById('bplaId').value,
          number: document.getElementById('number').value,
          supplier_id: document.getElementById('supplierId').value || null,
          controller_id: document.getElementById('controllerId').value || null,
          description: document.getElementById('description').value,
          traction_date: document.getElementById('traction_date').value || null,
          angle_date: document.getElementById('angle_date').value || null,
          acceleration_date: document.getElementById('acceleration_date').value || null,
          osd_date: document.getElementById('osd_date').value || null,
          osd_configured_date: document.getElementById('osd_configured_date').value || null,
          plugs_date: document.getElementById('plugs_date').value || null,
          engine_start_date: document.getElementById('engine_start_date').value || null,
      };

      const photoFile = document.getElementById('photo').files[0];
      let method = 'POST';
      let url = '/api/add_board';
      let boardIdForPhoto = null; // –ü–µ—Ä–µ–º–µ–Ω–Ω–∞—è –¥–ª—è ID –±–æ—Ä—Ç–∞ –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ

      // –ï—Å–ª–∏ editBoardId —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω, –∑–Ω–∞—á–∏—Ç –º—ã —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º, –∞ –Ω–µ —Å–æ–∑–¥–∞–µ–º
      if (editBoardId) {
          method = 'PUT';
          url = `/api/board/${editBoardId}`;
          boardIdForPhoto = editBoardId;
      }

      try {
          const res = await fetch(url, {
              method: method,
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify(body)
          });

          if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö –±–æ—Ä—Ç–∞');
          
          // –ï—Å–ª–∏ —ç—Ç–æ –±—ã–ª –Ω–æ–≤—ã–π –±–æ—Ä—Ç, –Ω–∞–º –Ω—É–∂–Ω–æ –ø–æ–ª—É—á–∏—Ç—å –µ–≥–æ ID –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ
          if (method === 'POST') {
              const newBoard = await res.json();
              boardIdForPhoto = newBoard.id;
          }

          // –õ–æ–≥–∏–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ñ–æ—Ç–æ (—Ç–µ–ø–µ—Ä—å —Ä–∞–±–æ—Ç–∞–µ—Ç –∏ –¥–ª—è –Ω–æ–≤—ã—Ö –±–æ—Ä—Ç–æ–≤)
          if (photoFile && boardIdForPhoto) {
              const formData = new FormData();
              // –ò–º—è —Ñ–∞–π–ª–∞ —Ç–µ–ø–µ—Ä—å –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç—Å—è –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ, –ø—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
              formData.append('photo', photoFile);
              
              await fetch(`/api/board/${boardIdForPhoto}/photo`, {
                  method: 'PUT', // –ò—Å–ø–æ–ª—å–∑—É–µ–º –æ–¥–∏–Ω –∏ —Ç–æ—Ç –∂–µ –º–∞—Ä—à—Ä—É—Ç –¥–ª—è —Ñ–æ—Ç–æ
                  body: formData
              });
          }
      } catch (error) {
          console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏–∏:', error);
          alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –±–æ—Ä—Ç. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–æ–Ω—Å–æ–ª—å –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –æ—à–∏–±–æ–∫.');
      }

      // –ü–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–π –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –¥–∞–Ω–Ω—ã–µ
      addModal.style.display = 'none';
      loadFilteredBoards();
      loadAndDisplayStatistics();
    });

    document.getElementById('filterForm').addEventListener('submit', (e) => {
      e.preventDefault();
      loadFilteredBoards();
    });

    document.getElementById('resetFilterBtn').addEventListener('click', () => {
      document.getElementById('filterForm').reset();
      loadFilteredBoards(); 
    });
    
    document.getElementById('exportBtn').addEventListener('click', exportToExcel);

    tableBody.addEventListener('change', async (e) => {
        if (e.target.classList.contains('table-param-checkbox')) {
            const checkbox = e.target;
            const boardId = checkbox.dataset.boardId;
            const paramName = checkbox.dataset.paramName;
            const today = new Date().toLocaleDateString('sv-SE');
            
            const dateToSet = checkbox.checked ? today : null;
            
            checkbox.disabled = true; // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞ –≤—Ä–µ–º—è –∑–∞–ø—Ä–æ—Å–∞
            const success = await updateBoardParameter(boardId, paramName, dateToSet);
            checkbox.disabled = false;

            if (success) {
                const dateDisplay = document.getElementById(`date-${boardId}-${paramName}`);
                dateDisplay.textContent = checkbox.checked ? new Date().toLocaleDateString('ru-RU') : '';
            } else {
                checkbox.checked = !checkbox.checked; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ
            }
        }
    });

    // --- 6. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã ---
    async function initPage() {
        // –õ–æ–≥–∏–∫–∞ –¥–ª—è –∞–≤—Ç–æ-—É—Å—Ç–∞–Ω–æ–≤–∫–∏ –¥–∞—Ç—ã –í–ù–£–¢–†–ò –ú–û–î–ê–õ–¨–ù–û–ì–û –û–ö–ù–ê
        const today = new Date().toLocaleDateString('sv-SE');
        document.querySelectorAll('#addModal input[type="checkbox"][data-date-target]').forEach(checkbox => {
            const dateInput = document.getElementById(checkbox.dataset.dateTarget);
            if (dateInput) {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        dateInput.classList.add('visible');
                        if (!dateInput.value) { dateInput.value = today; }
                    } else {
                        dateInput.classList.remove('visible');
                        dateInput.value = '';
                    }
                });
            }
        });
        await loadSuppliers();
        await loadAndDisplayStatistics();
        await loadBplaTypesForModal();
        await loadControllers();
        await loadControllerFilters();
        await initializeTabs(); // –≠—Ç–∞ —Ñ—É–Ω–∫—Ü–∏—è –≤—ã–∑–æ–≤–µ—Ç –ø–µ—Ä–≤—ã–π loadFilteredBoards
    }

    initPage();
  });
</script>
<script src="/js/main.js"></script>
</body>
</html>
