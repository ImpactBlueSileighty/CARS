<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>–¶–ê–†–°</title>
  <link rel="stylesheet" href="style/main.css" />
</head>
<body>

  <aside class="sidebar">
  <div class="sidebar-header">
    <h2>–¶–ê–†–°</h2>
  </div>
  <nav class="sidebar-nav">
    <ul>
      <li><a href="/">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
      <li><a href="/bpla.html">–ü—Ä–æ—à–∏–≤–∫–∏ –∏ –î–∞–º–ø—ã</a></li>
      <li><a href="#"></a></li>
    </ul>
  </nav>
</aside>

<main class="content">
  <h1>–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</h1>
  <div id="statisticsContainer" class="statistics-container">
  </div>
  <button id="openModalBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ä—Ç</button>
  <div id="bplaTabs" class="tabs-container">
  </div>
  <details class="filter-box">
    <summary>üîç –§–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫</summary>
    <form id="filterForm" class="filter-form">
      <div class="filter-controls">
        <label><input type="text" id="numberFilter" placeholder="–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞" /></label>
        <label>
          –ü–ö:
          <select id="controllerFilter"></select>
        </label>
        <label><input type="checkbox" id="tractionFilter" /> –¢—è–≥–∏</label>
        <label><input type="checkbox" id="angleFilter" /> –£–≥–ª—ã</label>
        <label><input type="checkbox" id="accelerationFilter" /> –ì–∞–∑</label>
        <label><input type="checkbox" id="osdFilter" /> OSD</label>
        <label><input type="checkbox" id="osdConfiguredFilter" /> –ü—Ä–æ—à–∏–≤–∫–∞ OSD</label>
        <label><input type="checkbox" id="plugsFilter" /> –°–≤–µ—á–∏</label>

        <div class="date-range">
          <label>–°: <input type="date" id="dateFrom" /></label>
          <label>–ü–æ: <input type="date" id="dateTo" /></label>
        </div>
      </div>

      <div class="filter-actions">
        <button type="button" id="resetFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
        <button type="button" id="exportBtn">üìÑ –≠–∫—Å–ø–æ—Ä—Ç –≤ Excel</button>
        <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
      </div>
    </form>
  </details>


  <!-- –¢–∞–±–ª–∏—Ü–∞ -->
  <table>
    <thead>
      <tr>
        <th>–§–æ—Ç–æ</th>
        <th>–ù–æ–º–µ—Ä</th>
        <th>–ü–ö</th>
        <th>–¢—è–≥–∏</th>
        <th>–£–≥–ª—ã</th>
        <th>–ì–∞–∑</th>
        <th>OSD</th>
        <th>–ü—Ä–æ—à–∏–≤–∫–∞ OSD</th>
        <th>–°–≤–µ—á–∏</th>
        <th>–û–ø–∏—Å–∞–Ω–∏–µ</th>
        <th>–î–∞—Ç–∞</th>
        <th>–ò–∑–º–µ–Ω–∏—Ç—å</th>
        <th>–£–¥–∞–ª–∏—Ç—å</th>
      </tr>
    </thead>
    <tbody id="boardTable"></tbody>
  </table>


  
  <!-- –ú–æ–¥–∞–ª–∫–∞ -->
  <div id="addModal">
    <div class="modal-content">
      <h3>–î–æ–±–∞–≤–∏—Ç—å –±–æ—Ä—Ç</h3>
      <form id="boardForm">
        <label>–¢–∏–ø –±–æ—Ä—Ç–∞:
          <select id="bplaId" required></select>
        </label>
        <input type="text" id="number" placeholder="–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞" required />
        <label>–ü–ö:
          <select id="controllerId"></select>
        </label>
        <label><input type="checkbox" id="traction" /> –¢—è–≥–∏</label>
        <label><input type="checkbox" id="angle" /> –£–≥–ª—ã</label>
        <label><input type="checkbox" id="acceleration" /> –ì–∞–∑</label>
        <label><input type="checkbox" id="osd" /> OSD</label>
        <label><input type="checkbox" id="osd_configured" /> –ü—Ä–æ—à–∏–≤–∫–∞ OSD</label>
        <label><input type="checkbox" id="plugs" /> –°–≤–µ—á–∏</label>
        <input type="text" id="description" placeholder="–û–ø–∏—Å–∞–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)" />
        <input type="file" id="photo" accept="images/*" />
        <div class="actions">
          <button type="submit">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
          <button type="button" id="closeModalBtn">–û—Ç–º–µ–Ω–∞</button>
        </div>
      </form>
    </div>
  </div>

  <!-- Zoom –æ–∫–Ω–æ -->
  <div id="zoomContainer" class="zoom-img" style="display: none;" onclick="this.style.display='none'">
    <img id="zoomedImg" src="" alt="–£–≤–µ–ª–∏—á–µ–Ω–æ" />
  </div>
</main>
  <script>
    let currentBplaId = null; // null –±—É–¥–µ—Ç –æ–∑–Ω–∞—á–∞—Ç—å "–í—Å–µ —Ç–∏–ø—ã"
    let editBoardId = null;
    const form = document.getElementById('boardForm');
    const tableBody = document.getElementById('boardTable');
    const addModal = document.getElementById('addModal');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');

    openModalBtn.onclick = () => {
      form.reset();
      editBoardId = null;
      // –ï—Å–ª–∏ –≤—ã–±—Ä–∞–Ω–∞ –≤–∫–ª–∞–¥–∫–∞ (–Ω–µ "–í—Å–µ"), —É—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —ç—Ç–æ—Ç —Ç–∏–ø –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      if (currentBplaId) {
        document.getElementById('bplaId').value = currentBplaId;
      }
      addModal.style.display = 'flex';
    };
    closeModalBtn.onclick = () => addModal.style.display = 'none';
    window.onclick = e => { if (e.target === addModal) addModal.style.display = 'none'; }

    // async function loadFilteredBoards() {
    //   const res = await fetch('/api/boards');
    //   const boards = await res.json();
    //   tableBody.innerHTML = '';

    //   boards.forEach(board => {
    //     const tr = document.createElement('tr');

    //     const formattedDate = new Date(board.sold_date).toLocaleDateString('ru-RU');

    //     const img = document.createElement('img');
    //     img.src = 'images/' + board.photo_path;
    //     img.onclick = () => {
    //       document.getElementById('zoomedImg').src = img.src;
    //       document.getElementById('zoomContainer').style.display = 'flex';
    //     };

    //     tr.innerHTML = `
    //       <td></td>
    //       <td>${board.number}</td>
    //       <td>${board.traction ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.angle ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.acceleration ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.osd ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.osd_configured ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.plugs ? '‚úÖ' : '‚ùå'}</td>
    //       <td>${board.description || ''}</td>
    //       <td>${formattedDate}</td>
    //       <td><button onclick="editBoard(${board.id})">‚úèÔ∏è</button></td>
    //       <td><button onclick="deleteBoard(${board.id})">üóë</button></td>
    //     `;
    //     tr.children[0].appendChild(img);
    //     tableBody.appendChild(tr);
    //   });
    // }

    async function editBoard(id) {
      const res = await fetch('/api/board/' + id);
      const board = await res.json();

      document.getElementById('number').value = board.number;
      document.getElementById('traction').checked = board.traction;
      document.getElementById('angle').checked = board.angle;
      document.getElementById('acceleration').checked = board.acceleration;
      document.getElementById('osd').checked = board.osd;
      document.getElementById('osd_configured').checked = board.osd_configured;
      document.getElementById('plugs').checked = board.plugs;
      document.getElementById('description').value = board.description || '';

      editBoardId = id;
      addModal.style.display = 'flex';
    }


    async function deleteBoard(id) {
      if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–æ—Ä—Ç?')) return;
      await fetch('/api/board/' + id, { method: 'DELETE' });
      loadFilteredBoards();
      loadAndDisplayStatistics();
    }

    
    //submit
    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      const body = {
        bpla_id: document.getElementById('bplaId').value,
        number: document.getElementById('number').value,
        traction: document.getElementById('traction').checked,
        angle: document.getElementById('angle').checked,
        acceleration: document.getElementById('acceleration').checked,
        osd: document.getElementById('osd').checked,
        osd_configured: document.getElementById('osd_configured').checked,
        plugs: document.getElementById('plugs').checked,
        description: document.getElementById('description').value,
        controller_id: document.getElementById('controllerId').value || null
      };

      const photoFile = document.getElementById('photo').files[0];

      if (editBoardId) {
        // –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        await fetch(`/api/board/${editBoardId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (photoFile) {
          const timestamp = new Date().toISOString().replace(/[-T:.Z]/g, '');
          const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
          const photo_path = `photo_${timestamp}_${randomSuffix}.jpg`;

          const formData = new FormData();

          formData.append('photo', new File([photoFile], photo_path));

          await fetch('/api/upload_photo', { method: 'POST', body: formData });

          // –æ–±–Ω–æ–≤–∏—Ç—å –ø—É—Ç—å —Ñ–æ—Ç–æ
          await fetch(`/api/board/${editBoardId}/photo`, {
            method: 'PUT',
            body: formData // üëà —É–±—Ä–∞–ª–∏ headers, –Ω–µ –Ω—É–∂–µ–Ω Content-Type ‚Äî –µ–≥–æ —Å—Ç–∞–≤–∏—Ç —Å–∞–º –±—Ä–∞—É–∑–µ—Ä
          });
        }

      } else {
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ
        const timestamp = new Date().toISOString().replace(/[-T:.Z]/g, '');
        const randomSuffix = Math.floor(Math.random() * 10000).toString().padStart(4, '0');
        const photo_path = `photo_${timestamp}_${randomSuffix}.jpg`;

        body.photo_path = photo_path;

        const res = await fetch('/api/add_board', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(body)
        });

        if (photoFile) {
          const formData = new FormData();
          formData.append('photo', new File([photoFile], photo_path));
          await fetch('/api/upload_photo', {
            method: 'POST',
            body: formData
          });
        }
      }

      form.reset();
      addModal.style.display = 'none';
      editBoardId = null;
      loadFilteredBoards();
      loadAndDisplayStatistics();
    });

    loadFilteredBoards();


    // –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —Ñ–∏–ª—å—Ç—Ä—ã –∏ –ø–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ—Ç —Ç–∞–±–ª–∏—Ü—É
    document.getElementById('filterForm').addEventListener('submit', async function(e) {
      e.preventDefault();
      await loadFilteredBoards();
    });

    // –û—á–∏—Å—Ç–∫–∞ —Ñ–∏–ª—å—Ç—Ä–æ–≤
    document.getElementById('resetFilterBtn').addEventListener('click', () => {
      document.getElementById('filterForm').reset();
      loadFilteredBoards(); // –æ–±—ã—á–Ω—ã–π –∑–∞–ø—Ä–æ—Å –±–µ–∑ —Ñ–∏–ª—å—Ç—Ä–∞
    });

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –∑–Ω–∞—á–µ–Ω–∏–π —Ñ–∏–ª—å—Ç—Ä–æ–≤
    function getFilters() {
      return {
        number: document.getElementById('numberFilter').value.trim(),
        controller_id: document.getElementById('controllerFilter').value || null,
        traction: document.getElementById('tractionFilter').checked,
        angle: document.getElementById('angleFilter').checked,
        acceleration: document.getElementById('accelerationFilter').checked,
        osd: document.getElementById('osdFilter').checked,
        osd_configured: document.getElementById('osdConfiguredFilter').checked,
        plugs: document.getElementById('plugsFilter').checked,
        date_from: document.getElementById('dateFrom').value,
        date_to: document.getElementById('dateTo').value,
      };
    }

    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ –∏ –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
    async function loadAndDisplayStatistics() {
      const container = document.getElementById('statisticsContainer');
      if (!container) return;

      try {
        const res = await fetch('/api/statistics');
        if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
        
        const stats = await res.json();
        
        if (stats.length === 0) {
          container.innerHTML = '<p>–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
          return;
        }

        let html = '';
        stats.forEach(typeStat => {
          html += `
            <div class="stat-item">
              <div class="stat-title">–í—Å–µ–≥–æ "${typeStat.name}": ${typeStat.total_count}</div>
              <div class="stat-values">
                <span class="finished">‚úÖ –ì–æ—Ç–æ–≤—ã–µ: ${typeStat.finished_count}</span>
                <span class="semi-finished">üõ†Ô∏è –í —Ä–∞–±–æ—Ç–µ: ${typeStat.semi_finished_count}</span>
              </div>
            </div>
          `;
        });
        container.innerHTML = html;
        
      } catch (error) {
        console.error("–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É:", error);
        container.innerHTML = '<p>–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É.</p>';
      }
    }

    // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç—Ñ–∏–ª—å—Ç—Ä–æ–≤–∞–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
    async function loadFilteredBoards() {

      const filters = getFilters(); // –ü–æ–ª—É—á–∞–µ–º —Ñ–∏–ª—å—Ç—Ä—ã –∏–∑ —Ñ–æ—Ä–º—ã
      filters.bpla_id = currentBplaId;
      const res = await fetch('/api/boards/filter', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(filters)
      });

      if (!res.ok) {
        console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö:', res.statusText);
        tableBody.innerHTML = `
          <tr><td colspan="12" style="text-align:center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö</td></tr>
        `;
        return;
      }

      const boards = await res.json();

      tableBody.innerHTML = '';
      if (!boards.length) {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td colspan="12" style="text-align:center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td>`;
        tableBody.appendChild(tr);
        return;
      }

      boards.forEach(board => {
        const tr = document.createElement('tr');
        const formattedDate = new Date(board.sold_date).toLocaleDateString('ru-RU');
        const img = document.createElement('img');
        img.src = 'images/' + board.photo_path;
        img.onclick = () => {
          document.getElementById('zoomedImg').src = img.src;
          document.getElementById('zoomContainer').style.display = 'flex';
        };
        tr.innerHTML = `
          <td></td>
          <td>${board.number}</td>
          <td>${board.controller_name}</td>
          <td>${board.traction ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.angle ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.acceleration ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.osd ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.osd_configured ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.plugs ? '‚úÖ' : '‚ùå'}</td>
          <td>${board.description || ''}</td>
          <td>${formattedDate}</td>
          <td><button onclick="editBoard(${board.id})">‚úèÔ∏è</button></td>
          <td><button onclick="deleteBoard(${board.id})">üóë</button></td>
        `;
        tr.children[0].appendChild(img);
        tableBody.appendChild(tr);
      });
    }

    async function loadControllers() {
      const res = await fetch('/api/controllers');
      const controllers = await res.json();
      const select = document.getElementById('controllerId');
      select.innerHTML = '<option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>';
      controllers.forEach(ctrl => {
        const option = document.createElement('option');
        option.value = ctrl.id;
        option.textContent = `${ctrl.name} (${ctrl.dump})`;
        select.appendChild(option);
      });
    }

    async function loadControllerFilters() {
      const res = await fetch('/api/controllers');
      const controllers = await res.json();
      const select = document.getElementById('controllerFilter');
      select.innerHTML = '<option value="">–õ—é–±–æ–π</option>';
      controllers.forEach(ctrl => {
        const option = document.createElement('option');
        option.value = ctrl.id;
        option.textContent = `${ctrl.name} (${ctrl.dump})`;
        select.appendChild(option);
      });
    }

    async function loadAndRenderBplaTabs() {
      const tabsContainer = document.getElementById('bplaTabs');
      const res = await fetch('/api/bpla');
      const bplaTypes = await res.json();

      // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫—É "–í—Å–µ"
      const allTab = document.createElement('button');
      allTab.className = 'tab-btn active'; // "–í—Å–µ" –∞–∫—Ç–∏–≤–Ω–æ –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é
      allTab.textContent = '–í—Å–µ';
      allTab.onclick = () => {
        currentBplaId = null;
        setActiveTab(allTab);
        loadFilteredBoards(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ –±–æ—Ä—Ç—ã
      };
      tabsContainer.appendChild(allTab);

      // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏ –¥–ª—è –∫–∞–∂–¥–æ–≥–æ —Ç–∏–ø–∞
      bplaTypes.forEach(type => {
        const tab = document.createElement('button');
        tab.className = 'tab-btn';
        tab.textContent = type.name;
        tab.dataset.bplaId = type.id; // –°–æ—Ö—Ä–∞–Ω—è–µ–º ID –≤ data-–∞—Ç—Ä–∏–±—É—Ç–µ
        tab.onclick = () => {
          currentBplaId = type.id;
          setActiveTab(tab);
          loadFilteredBoards(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –±–æ—Ä—Ç—ã –¥–ª—è —ç—Ç–æ–≥–æ —Ç–∏–ø–∞
        };
        tabsContainer.appendChild(tab);
      });
    }

    function setActiveTab(activeButton) {
      // –£–±–∏—Ä–∞–µ–º –∫–ª–∞—Å—Å 'active' —É –≤—Å–µ—Ö –≤–∫–ª–∞–¥–æ–∫
      document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
      // –î–æ–±–∞–≤–ª—è–µ–º –∫–ª–∞—Å—Å 'active' –Ω–∞–∂–∞—Ç–æ–π –∫–Ω–æ–ø–∫–µ
      activeButton.classList.add('active');
    }

    async function loadBplaTypesForModal() {
      const select = document.getElementById('bplaId');
      select.innerHTML = ''; // –û—á–∏—â–∞–µ–º
      
      const res = await fetch('/api/bpla');
      const bplaTypes = await res.json();
      
      bplaTypes.forEach(type => {
        const option = document.createElement('option');
        option.value = type.id;
        option.textContent = type.name;
        select.appendChild(option);
      });
    }


    // –ù–æ–≤–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è —ç–∫—Å–ø–æ—Ä—Ç–∞ –¥–∞–Ω–Ω—ã—Ö –≤ Excel
    async function exportToExcel() {
      const exportButton = document.getElementById('exportBtn');
      const originalText = exportButton.innerHTML;
      
      // –°–æ–±–∏—Ä–∞–µ–º –≤—Å–µ —Ç–µ–∫—É—â–∏–µ —Ñ–∏–ª—å—Ç—Ä—ã —Å–æ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
      const filters = getFilters();
      filters.bpla_id = currentBplaId;

      // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é, —á—Ç–æ –∏–¥–µ—Ç –ø—Ä–æ—Ü–µ—Å—Å
      exportButton.disabled = true;
      exportButton.innerHTML = '–ó–∞–≥—Ä—É–∑–∫–∞...';

      try {
        const res = await fetch('/api/boards/export', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(filters)
        });

        if (!res.ok) {
          throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ñ–∞–π–ª–∞');
        }

        // –ü–æ–ª—É—á–∞–µ–º —Ñ–∞–π–ª –∫–∞–∫ Blob (–±–∏–Ω–∞—Ä–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ)
        const blob = await res.blob();
        
        // –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—É—é —Å—Å—ã–ª–∫—É –¥–ª—è —Å–∫–∞—á–∏–≤–∞–Ω–∏—è —Ñ–∞–π–ª–∞
        const url = window.URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.style.display = 'none';
        a.href = url;
        // –ò–º—è —Ñ–∞–π–ª–∞ –±—É–¥–µ—Ç –∑–∞–¥–∞–Ω–æ —Å–µ—Ä–≤–µ—Ä–æ–º, –Ω–æ –º–æ–∂–Ω–æ —É–∫–∞–∑–∞—Ç—å –∏ –∑–¥–µ—Å—å
        a.download = `bpla_export_${new Date().toLocaleDateString('sv-SE')}.xlsx`;
        document.body.appendChild(a);
        
        a.click(); // –ò–º–∏—Ç–∏—Ä—É–µ–º –∫–ª–∏–∫ –¥–ª—è –Ω–∞—á–∞–ª–∞ —Å–∫–∞—á–∏–≤–∞–Ω–∏—è
        
        // –û—á–∏—â–∞–µ–º –∑–∞ —Å–æ–±–æ–π
        window.URL.revokeObjectURL(url);
        a.remove();

      } catch (error) {
        console.error('–û—à–∏–±–∫–∞ –ø—Ä–∏ —ç–∫—Å–ø–æ—Ä—Ç–µ:', error);
        alert('–ù–µ —É–¥–∞–ª–æ—Å—å —ç–∫—Å–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å –¥–∞–Ω–Ω—ã–µ.');
      } finally {
        // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –∫–Ω–æ–ø–∫—É –≤ –∏—Å—Ö–æ–¥–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ
        exportButton.disabled = false;
        exportButton.innerHTML = originalText;
      }
    }

    document.addEventListener("DOMContentLoaded", async () => {
      await loadAndDisplayStatistics();
      await loadBplaTypesForModal(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Ç–∏–ø—ã –¥–ª—è –º–æ–¥–∞–ª–∫–∏
      await loadAndRenderBplaTabs();   // –°–æ–∑–¥–∞–µ–º –≤–∫–ª–∞–¥–∫–∏
      await loadControllers();         // –î–ª—è —Ñ–æ—Ä–º—ã –¥–æ–±–∞–≤–ª–µ–Ω–∏—è/—Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
      await loadControllerFilters(); 
       document.getElementById('exportBtn').addEventListener('click', exportToExcel); 
      loadFilteredBoards();            // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—á–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ (–≤–∫–ª–∞–¥–∫–∞ "–í—Å–µ")
    });

  </script>
</body>
</html>
