<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–¶–ê–†–° - –°–≤–æ–¥–∫–∞</title>
    <link rel="stylesheet" href="/style/main.css" />
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">
        <h2>–¶–ê–†–°</h2>
    </div>

    <nav class="sidebar-nav">
        <details class="nav-section">
            <summary class="nav-title">–°–ª–µ—Å–∞—Ä–Ω—ã–π —Ü–µ—Ö</summary>
            <ul>
                <li><a href="/">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
            </ul>
        </details>
        <details class="nav-section">
            <summary class="nav-title">–û—Ç–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</summary>
            <ul>
                <li><a href="/setup.html">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
                <li><a href="/bpla.html">–ü—Ä–æ—à–∏–≤–∫–∏ –∏ –î–∞–º–ø—ã</a></li>
            </ul>
        </details>
        <div class="nav-common">
            <ul>
                <li><a href="/summary.html">–°–≤–æ–¥–∫–∞</a></li>
            </ul>
        </div>
    </nav>

    <div class="sidebar-footer">
        <div class="user-info">
        <div class="user-avatar">ü¶õ</div>
        <div class="user-details">
            <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span id="userRole">–†–æ–ª—å –Ω–µ –∑–∞–¥–∞–Ω–∞</span>
        </div>
        </div>
        <a href="#" id="logoutBtn" class="logout-button">–í—ã–π—Ç–∏</a>
    </div>
</aside>

<main class="content">
    <h1>–û–±—â–∞—è —Å–≤–æ–¥–∫–∞ –ø–æ –±–æ—Ä—Ç–∞–º</h1>
    <p class="subtitle">–°—Ç–∞—Ç—É—Å –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏ –≤—Å–µ—Ö –±–æ—Ä—Ç–æ–≤ –≤ —Å–∏—Å—Ç–µ–º–µ.</p>

    <div id="summaryStatisticsContainer" class="summary-stats-grid"></div>

    <details class="filter-box">
        <summary>üîç –§–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫</summary>
        <form id="filterForm" class="filter-form">
            <div class="filter-controls">
                <div class="primary-filters">
                    <label>–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞: <input type="text" id="numberFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä..." /></label>
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫: <select id="supplierFilter"><option value="">–í—Å–µ</option></select></label>
                    <label>–¢–∏–ø –ë–ü–õ–ê: <select id="bplaFilter"><option value="">–í—Å–µ</option></select></label>
                    <label>–°—Ç–∞—Ç—É—Å:
                        <select id="statusFilter">
                            <option value="">–õ—é–±–æ–π</option>
                            <option value="finished">–ì–æ—Ç–æ–≤—ã–µ (–∑–µ–ª–µ–Ω—ã–µ)</option>
                            <option value="overdue">–ü—Ä–æ—Å—Ä–æ—á–µ–Ω–æ (–∫—Ä–∞—Å–Ω—ã–µ)</option>
                            <option value="today">–í —Ä–∞–±–æ—Ç–µ (–æ—Ä–∞–Ω–∂–µ–≤—ã–µ)</option>
                        </select>
                    </label>
                </div>
            </div>
            <div class="filter-actions">
                <button type="button" id="resetFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </form>
    </details>

     <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>–ù–æ–º–µ—Ä</th> <th>–¢–∏–ø</th> <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                    <th>–°–ª–µ—Å–∞—Ä–Ω—ã–π —Ü–µ—Ö</th> <th>–û—Ç–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</th>
                    <th>–î–∞—Ç–∞ —Å–æ–∑–¥–∞–Ω–∏—è</th> <th>–î–∞—Ç–∞ –≥–æ—Ç–æ–≤–Ω–æ—Å—Ç–∏</th>
                </tr>
            </thead>
            <tbody id="summaryTableBody"></tbody>
        </table>
    </div>
</main>

<script src="/js/main.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.getElementById('summaryTableBody');
    const statsContainer = document.getElementById('summaryStatisticsContainer');

    // --- –ù–û–í–´–ï –§–£–ù–ö–¶–ò–ò –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ø–∏—Å–∫–æ–≤ –≤ —Ñ–∏–ª—å—Ç—Ä—ã ---
    const loadSuppliers = async () => {
        const select = document.getElementById('supplierFilter');
        try {
            const res = await fetch('/api/suppliers');
            const suppliers = await res.json();
            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
            });
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"); }
    };

    const loadBplaTypes = async () => {
        const select = document.getElementById('bplaFilter');
        try {
            const res = await fetch('/api/bpla');
            const bplaTypes = await res.json();
            bplaTypes.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –ë–ü–õ–ê"); }
    };

    const getFilters = () => ({
        number: document.getElementById('numberFilter').value.trim(),
        supplier_id: document.getElementById('supplierFilter').value || null,
        bpla_id: document.getElementById('bplaFilter').value || null,
        status: document.getElementById('statusFilter').value,
    });

    const renderStats = (stats) => {
        if (!statsContainer) return;
        statsContainer.innerHTML = '';
        stats.forEach(stat => {
            const card = document.createElement('div');
            card.className = 'stat-card';

            // –§–æ—Ä–º–∏—Ä—É–µ–º —Å—Ç—Ä–æ–∫—É –¥–ª—è —Å—á–µ—Ç—á–∏–∫–∞ "–∑–∞ —Å–µ–≥–æ–¥–Ω—è", —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –æ–Ω –±–æ–ª—å—à–µ –Ω—É–ª—è
            const todayCountHtml = stat.green_today > 0 
                ? `<span class="stat-today">(+${stat.green_today})</span>` 
                : '';

            card.innerHTML = `
                <div class="stat-card-title">${stat.bpla_name || '–ù–µ —É–∫–∞–∑–∞–Ω'}</div>
                <div class="stat-card-body">
                    <div class="stat-card-row">
                        <span class="stat-label green">–ì–æ—Ç–æ–≤—ã–µ</span>
                        <span class="stat-value">${stat.green} ${todayCountHtml}</span>
                    </div>
                    <div class="stat-card-row"><span class="stat-label red">–ü–æ–ª—É—Ñ–∞–±—Ä–∏–∫–∞—Ç—ã</span> <span class="stat-value">${stat.red}</span></div>
                    <div class="stat-card-row"><span class="stat-label orange">–í —Ä–∞–±–æ—Ç–µ (—Å–µ–≥–æ–¥–Ω—è)</span> <span class="stat-value">${stat.orange}</span></div>
                </div>
            `;
            statsContainer.appendChild(card);
        });
    };

    const renderTable = (boards) => {
        tableBody.innerHTML = '';
        if (!boards || boards.length === 0) {
            tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            return;
        }
        const formatDate = date => date ? new Date(date).toLocaleDateString('ru-RU') : '‚Äî';
        boards.forEach(board => {
            const tr = document.createElement('tr');

            // --- –£–ü–†–û–©–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –ü–û–î–°–í–ï–¢–ö–ò ---
            // –ü—Ä–æ—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º —Å—Ç–∞—Ç—É—Å, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–∏—Å–ª–∞–ª —Å–µ—Ä–≤–µ—Ä
            if (board.status_color === 'green') {
                tr.className = 'row-finished';
            } else if (board.status_color === 'orange') {
                tr.className = 'row-in-progress-today';
            } else if (board.status_color === 'red') {
                tr.className = 'row-in-progress-overdue';
            }

            tr.innerHTML = `
                <td>${board.number}</td>
                <td>${board.bpla_name || 'N/A'}</td>
                <td>${board.supplier_name || 'N/A'}</td>
                <td>${board.workshop_complete ? '‚úÖ' : '‚ùå'}</td>
                <td>${board.setup_complete ? '‚úÖ' : '‚ùå'}</td>
                <td>${formatDate(board.creation_date)}</td>
                <td>${formatDate(board.finished_date)}</td>
            `;
            tableBody.appendChild(tr);
        });
    };

    const loadSummaryData = async (filters = {}) => {
        try {
            const [statsRes, boardsRes] = await Promise.all([
                fetch('/api/summary/statistics'),
                fetch('/api/summary/filter', { 
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(filters)
                })
            ]);

            if (!statsRes.ok || !boardsRes.ok) {
                // –ü–æ–ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å —Ç–µ–∫—Å—Ç –æ—à–∏–±–∫–∏ —Å —Å–µ—Ä–≤–µ—Ä–∞
                const errorText = await (statsRes.ok ? boardsRes : statsRes).text();
                throw new Error(`–û—à–∏–±–∫–∞ –æ—Ç–≤–µ—Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞: ${errorText}`);
            }

            renderStats(await statsRes.json());
            renderTable(await boardsRes.json());
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å–≤–æ–¥–∫–∏:', error);
            if(statsContainer) statsContainer.innerHTML = '<p>–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏.</p>';
            if(tableBody) tableBody.innerHTML = `<tr><td colspan="7" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã.</td></tr>`;
        }
    };
    
    document.getElementById('filterForm').addEventListener('submit', (e) => {
        e.preventDefault();
        loadSummaryData(getFilters());
    });

    document.getElementById('resetFilterBtn').addEventListener('click', () => {
        document.getElementById('filterForm').reset();
        loadSummaryData();
    });

    const initPage = async () => {
        await loadSuppliers();
        await loadBplaTypes();
        await loadSummaryData();
    };

    initPage();
});
</script>
</body>
</html>