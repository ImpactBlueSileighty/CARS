<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>–¶–ê–†–° - –°–ª–µ—Å–∞—Ä–Ω—ã–π —Ü–µ—Ö</title>
    <link rel="stylesheet" href="/style/main.css" />
</head>
<body>

<aside class="sidebar">
    <div class="sidebar-header">
        <h2>–¶–ê–†–°</h2>
    </div>

    <nav class="sidebar-nav">
        <details class="nav-section">
            <summary class="nav-title">–°–ª–µ—Å–∞—Ä–Ω—ã–π —Ü–µ—Ö</summary>
            <ul>
                <li><a href="/">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
            </ul>
        </details>
        <details class="nav-section">
            <summary class="nav-title">–û—Ç–¥–µ–ª –Ω–∞—Å—Ç—Ä–æ–π–∫–∏</summary>
            <ul>
                <li><a href="/setup.html">–°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</a></li>
                <li><a href="/bpla.html">–ü—Ä–æ—à–∏–≤–∫–∏ –∏ –î–∞–º–ø—ã</a></li>
            </ul>
        </details>
        <div class="nav-common">
            <ul>
                <li><a href="/summary.html">–°–≤–æ–¥–∫–∞</a></li>
            </ul>
        </div>
    </nav>

    <div class="sidebar-footer">
        <div class="user-info">
        <div class="user-avatar">ü¶õ</div>
        <div class="user-details">
            <span id="userName">–ó–∞–≥—Ä—É–∑–∫–∞...</span>
            <span id="userRole">–†–æ–ª—å –Ω–µ –∑–∞–¥–∞–Ω–∞</span>
        </div>
        </div>
        <a href="#" id="logoutBtn" class="logout-button">–í—ã–π—Ç–∏</a>
    </div>
</aside>

<main class="content">
    <h1>–°–ª–µ—Å–∞—Ä–Ω—ã–π —Ü–µ—Ö: –°–ø–∏—Å–æ–∫ –±–æ—Ä—Ç–æ–≤</h1>
    
    <button id="openModalBtn">‚ûï –î–æ–±–∞–≤–∏—Ç—å –±–æ—Ä—Ç</button>

    <details class="filter-box">
        <summary>üîç –§–∏–ª—å—Ç—Ä –∏ –ø–æ–∏—Å–∫</summary>
        <form id="filterForm" class="filter-form">
            <div class="filter-controls">
                <div class="primary-filters">
                    <label>–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞: <input type="text" id="numberFilter" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–æ–º–µ—Ä..." /></label>
                    <label>–ü–æ—Å—Ç–∞–≤—â–∏–∫: <select id="supplierFilter"><option value="">–í—Å–µ</option></select></label>
                </div>
                <fieldset class="checkbox-fieldset">
                    <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã</legend>
                    <div class="checkbox-group">
                        <label><input type="checkbox" id="engineInstallationFilter" /> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –î–í–°</label>
                        <label><input type="checkbox" id="catapultHooksFilter" /> –ó–∞—Ü–µ–ø—ã</label>
                        <label><input type="checkbox" id="fuelSystemFilter" /> –¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</label>
                        <label><input type="checkbox" id="rodsFilter" /> –¢—è–≥–∏</label>
                        <label><input type="checkbox" id="leadWeightFilter" /> –°–≤–∏–Ω—Ü–æ–≤—ã–π –≥—Ä—É–∑</label>
                    </div>
                </fieldset>
            </div>
            <div class="filter-actions">
                <button type="button" id="resetFilterBtn">–°–±—Ä–æ—Å–∏—Ç—å</button>
                <button type="submit">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            </div>
        </form>
    </details>

    <div class="table-container">
        <table>
            <thead>
                <tr>
                    <th>–ù–æ–º–µ—Ä</th>
                    <th>–¢–∏–ø –±–æ—Ä—Ç–∞</th>
                    <th>–ü–æ—Å—Ç–∞–≤—â–∏–∫</th>
                    <th>–£—Å—Ç–∞–Ω–æ–≤–∫–∞ –î–í–°</th>
                    <th>–ó–∞—Ü–µ–ø—ã –∫–∞—Ç–∞–ø—É–ª—å—Ç—ã</th>
                    <th>–¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</th>
                    <th>–¢—è–≥–∏</th>
                    <th>–°–≤–∏–Ω—Ü–æ–≤—ã–π –≥—Ä—É–∑</th>
                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                </tr>
            </thead>
            <tbody id="workshopTableBody"></tbody>
        </table>
    </div>

    <div id="addModal">
        <div class="modal-content">
            <h3>–î–æ–±–∞–≤–∏—Ç—å/–ò–∑–º–µ–Ω–∏—Ç—å –±–æ—Ä—Ç</h3>
            <form id="boardForm">
                <div class="form-grid">
                    <label for="bplaId">–¢–∏–ø –±–æ—Ä—Ç–∞:</label>
                    <select id="bplaId" required></select>
                    <label for="number">–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞:</label>
                    <input type="text" id="number" placeholder="–ù–æ–º–µ—Ä –±–æ—Ä—Ç–∞" required />
                    <label for="supplierId">–ü–æ—Å—Ç–∞–≤—â–∏–∫:</label>
                    <select id="supplierId"></select>
                </div>
                <fieldset class="params-fieldset">
                    <legend>–ü–∞—Ä–∞–º–µ—Ç—Ä—ã —Ü–µ—Ö–∞</legend>
                    <div class="param-group">
                        <label><input type="checkbox" data-date-target="engine_installation_date" /> –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –î–í–°</label>
                        <input type="date" id="engine_installation_date" class="param-date-input" />
                    </div>
                    <div class="param-group">
                        <label><input type="checkbox" data-date-target="catapult_hooks_date" /> –ó–∞—Ü–µ–ø—ã –∫–∞—Ç–∞–ø—É–ª—å—Ç—ã</label>
                        <input type="date" id="catapult_hooks_date" class="param-date-input" />
                    </div>
                    <div class="param-group">
                        <label><input type="checkbox" data-date-target="fuel_system_date" /> –¢–æ–ø–ª–∏–≤–Ω–∞—è —Å–∏—Å—Ç–µ–º–∞</label>
                        <input type="date" id="fuel_system_date" class="param-date-input" />
                    </div>
                    <div class="param-group">
                        <label><input type="checkbox" data-date-target="workshop_rods_date" /> –¢—è–≥–∏</label>
                        <input type="date" id="workshop_rods_date" class="param-date-input" />
                    </div>
                    <div class="param-group">
                        <label><input type="checkbox" data-date-target="lead_weight_date" /> –°–≤–∏–Ω—Ü–æ–≤—ã–π –≥—Ä—É–∑</label>
                        <input type="date" id="lead_weight_date" class="param-date-input" />
                    </div>
                </fieldset>
                <div class="actions">
                    <button type="button" id="closeModalBtn" class="btn-secondary">–û—Ç–º–µ–Ω–∞</button>
                    <button type="submit" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </form>
        </div>
    </div>
    <div id="commentTooltip" class="comment-tooltip" style="display: none;"></div>

    <div id="commentModal" class="comment-editor-modal" style="display: none;">
        <div class="comment-editor-content">
            <h4>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π –∫ –ø–∞—Ä–∞–º–µ—Ç—Ä—É: <span id="commentParamName"></span></h4>
            <textarea id="commentTextarea" rows="4" placeholder="–í–≤–µ–¥–∏—Ç–µ –Ω–µ–∏—Å–ø—Ä–∞–≤–Ω–æ—Å—Ç—å –∏–ª–∏ –∑–∞–º–µ—Ç–∫—É..."></textarea>
            <div class="comment-editor-actions">
                <button id="deleteCommentBtn" class="btn-danger">–£–¥–∞–ª–∏—Ç—å</button>
                <div>
                    <button type="button" id="closeCommentModalBtn" class="btn-secondary">–ó–∞–∫—Ä—ã—Ç—å</button>
                    <button type="button" id="saveCommentBtn" class="btn-primary">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                </div>
            </div>
        </div>
    </div>
</main>

<script src="/js/main.js"></script>
<script>
document.addEventListener("DOMContentLoaded", () => {
    const tableBody = document.getElementById('workshopTableBody');
    const modal = document.getElementById('addModal');
    const form = document.getElementById('boardForm');
    const openModalBtn = document.getElementById('openModalBtn');
    const closeModalBtn = document.getElementById('closeModalBtn');
    const tooltip = document.getElementById('commentTooltip');
    const commentModal = document.getElementById('commentModal');
    let editBoardId = null;

    const workshopParams = ['engine_installation_date', 'catapult_hooks_date', 'fuel_system_date', 'workshop_rods_date', 'lead_weight_date'];


    const loadBplaTypesForModal = async () => {
        const select = document.getElementById('bplaId');
        if (!select) return;
        select.innerHTML = '';
        try {
            const res = await fetch('/api/bpla');
            const bplaTypes = await res.json();
            
            // –î–æ–±–∞–≤–ª—è–µ–º —Ç–æ–ª—å–∫–æ –∫–æ–Ω–µ—á–Ω—ã–µ —Ç–∏–ø—ã (—É –∫–æ—Ç–æ—Ä—ã—Ö –Ω–µ—Ç –¥–æ—á–µ—Ä–Ω–∏—Ö)
            const parentIds = new Set(bplaTypes.map(b => b.parent_id).filter(id => id !== null));
            const filteredBplas = bplaTypes.filter(b => !parentIds.has(b.id));

            filteredBplas.forEach(type => {
                const option = document.createElement('option');
                option.value = type.id;
                option.textContent = type.name;
                select.appendChild(option);
            });
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∏–ø–æ–≤ –ë–ü–õ–ê"); }
    };
    // --- –§–£–ù–ö–¶–ò–ò API ---
    const getFilters = () => ({
        number: document.getElementById('numberFilter').value.trim(),
        supplier_id: document.getElementById('supplierFilter').value || null,
        engine_installation: document.getElementById('engineInstallationFilter').checked,
        catapult_hooks: document.getElementById('catapultHooksFilter').checked,
        fuel_system: document.getElementById('fuelSystemFilter').checked,
        rods: document.getElementById('workshopRodsFilter').checked,
        lead_weight: document.getElementById('leadWeightFilter').checked,
    });

    const updateBoardParameter = async (boardId, parameter, date) => {
        try {
            const res = await fetch(`/api/workshop/${boardId}/parameter`, {
                method: 'PATCH',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ parameter, date })
            });
            return res.ok;
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (—Ü–µ—Ö):', error);
            return false;
        }
    };

    const loadBoards = async () => {
        try {
            const res = await fetch('/api/workshop/filter', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(getFilters())
            });
            if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–µ—Ç–∏');
            renderTable(await res.json());
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –¥–∞–Ω–Ω—ã—Ö (—Ü–µ—Ö):', error);
            tableBody.innerHTML = `<tr><td colspan="8" style="text-align: center;">–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</td></tr>`;
        }
    };
    
    const loadSuppliers = async (selectElementId) => {
        const select = document.getElementById(selectElementId);
        if (!select) return;
        try {
            const res = await fetch('/api/suppliers');
            const suppliers = await res.json();
            // –û—á–∏—â–∞–µ–º, –æ—Å—Ç–∞–≤–ª—è—è –ø–µ—Ä–≤—ã–π option (–µ—Å–ª–∏ –æ–Ω –µ—Å—Ç—å)
            const firstOption = select.firstElementChild;
            select.innerHTML = '';
            if (firstOption) select.appendChild(firstOption);

            suppliers.forEach(s => {
                const option = document.createElement('option');
                option.value = s.id;
                option.textContent = s.name;
                select.appendChild(option);
            });
        } catch(e) { console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ—Å—Ç–∞–≤—â–∏–∫–æ–≤"); }
    };

    // --- –†–ï–ù–î–ï–†–ò–ù–ì –ò UI ---
    const renderTable = (boards) => {
        tableBody.innerHTML = '';
        if (!boards.length) {
            tableBody.innerHTML = `<tr><td colspan="9" style="text-align: center;">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</td></tr>`;
            return;
        }
        const formatDate = date => date ? new Date(date).toLocaleDateString('ru-RU') : '';
        boards.forEach(board => {
            const tr = document.createElement('tr');
            let paramsHtml = '';
            workshopParams.forEach(param => {
                const hasDate = !!board[param];
                const comment = board.workshop_comments ? board.workshop_comments[param] : null;
                const hasCommentClass = comment ? 'has-comment' : '';

                const headerIndex = workshopParams.indexOf(param) + 4;
                const headerText = document.querySelector(`thead th:nth-child(${headerIndex})`).textContent;

                paramsHtml += `
                    <td class="parameter-cell ${hasCommentClass}" data-comment="${comment || ''}">
                        ${comment ? '<span class="comment-indicator">üí¨</span>' : ''}
                        <input type="checkbox" class="table-param-checkbox" 
                               data-board-id="${board.id}" data-param-name="${param}" ${hasDate ? 'checked' : ''}>
                        <div class="param-date-display">${formatDate(board[param])}</div>
                        <button class="edit-comment-btn" data-board-id="${board.id}" data-param-name="${param}" data-param-label="${headerText}">‚úèÔ∏è</button>
                    </td>`;
            });
            tr.innerHTML = `
                <td>${board.number}</td>
                <td>${board.bpla_name || 'N/A'}</td>
                <td>${board.supplier_name || 'N/A'}</td>
                ${paramsHtml}
                <td class="actions-cell">
                    <button onclick="editBoard(${board.id})">‚úèÔ∏è</button>
                    <button onclick="deleteBoard(${board.id})">üóëÔ∏è</button>
                </td>
            `;
            tableBody.appendChild(tr);
        });
    };

    // --- –ù–û–í–ê–Ø –õ–û–ì–ò–ö–ê –î–õ–Ø –ö–û–ú–ú–ï–ù–¢–ê–†–ò–ï–í ---
    function initCommentEditor() {
    // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º/–ø—Ä—è—á–µ–º —Ç—É–ª—Ç–∏–ø —Å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–º
        tableBody.addEventListener('mouseover', e => {
            const cell = e.target.closest('.parameter-cell');
            if (cell && cell.dataset.comment) {
                tooltip.textContent = cell.dataset.comment;
                tooltip.style.display = 'block';
            }
        });
        tableBody.addEventListener('mousemove', e => {
            tooltip.style.left = e.pageX + 15 + 'px';
            tooltip.style.top = e.pageY + 15 + 'px';
        });
        tableBody.addEventListener('mouseout', () => {
            tooltip.style.display = 'none';
        });

        let currentCommentData = {};

        // –û—Ç–∫—Ä—ã–≤–∞–µ–º –æ–∫–Ω–æ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏—è
        tableBody.addEventListener('click', e => {
            if (e.target.classList.contains('edit-comment-btn')) {
                const button = e.target;
                currentCommentData = {
                    boardId: button.dataset.boardId,
                    paramName: button.dataset.paramName,
                };
                document.getElementById('commentParamName').textContent = button.dataset.paramLabel;
                const currentComment = button.closest('.parameter-cell').dataset.comment;
                document.getElementById('commentTextarea').value = currentComment;
                commentModal.style.display = 'flex';
            }
        });

        // --- –ò–°–ü–†–ê–í–õ–ï–ù–ù–ê–Ø –õ–û–ì–ò–ö–ê –°–û–•–†–ê–ù–ï–ù–ò–Ø/–£–î–ê–õ–ï–ù–ò–Ø ---

        // –ï–¥–∏–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è –¥–ª—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –¥–∞–Ω–Ω—ã—Ö –Ω–∞ —Å–µ—Ä–≤–µ—Ä
        const saveComment = async (commentText) => {
            try {
                const res = await fetch(`/api/workshop/${currentCommentData.boardId}/comment`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        parameter: currentCommentData.paramName,
                        comment: commentText
                    })
                });
                if (!res.ok) throw new Error('–û—à–∏–±–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è');
                commentModal.style.display = 'none';
                loadBoards(); // –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∂–∞–µ–º —Ç–∞–±–ª–∏—Ü—É –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è
            } catch (error) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π.');
                console.error(error);
            }
        };

        // –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º —Å–æ–±—ã—Ç–∏—è –∫ –∫–Ω–æ–ø–∫–∞–º –º–æ–¥–∞–ª—å–Ω–æ–≥–æ –æ–∫–Ω–∞
        document.getElementById('closeCommentModalBtn').onclick = () => commentModal.style.display = 'none';

        document.getElementById('saveCommentBtn').onclick = () => {
            const newComment = document.getElementById('commentTextarea').value;
            saveComment(newComment);
        };

        document.getElementById('deleteCommentBtn').onclick = () => {
            // –î–ª—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ—Å—Ç–æ —Å–æ—Ö—Ä–∞–Ω—è–µ–º –ø—É—Å—Ç—É—é —Å—Ç—Ä–æ–∫—É
            saveComment('');
        };
    }


    // --- CRUD –§–£–ù–ö–¶–ò–ò ---
    window.editBoard = async (id) => {
        form.reset();
        document.querySelectorAll('.param-date-input').forEach(input => input.classList.remove('visible'));
        try {
            const res = await fetch(`/api/board/${id}`);
            if(!res.ok) throw new Error('–ë–æ—Ä—Ç –Ω–µ –Ω–∞–π–¥–µ–Ω');
            const board = await res.json();
            
            document.getElementById('bplaId').value = board.bpla_id;
            document.getElementById('number').value = board.number;
            document.getElementById('supplierId').value = board.supplier_id || '';
            

            
            const formatDateForInput = (date) => date ? new Date(date).toLocaleDateString('sv-SE') : '';
            workshopParams.forEach(paramName => {
                const checkbox = document.querySelector(`[data-date-target="${paramName}"]`);
                const dateInput = document.getElementById(paramName);
                if (checkbox && dateInput) {
                    const hasDate = !!board[paramName];
                    checkbox.checked = hasDate;
                    if(hasDate) {
                        dateInput.value = formatDateForInput(board[paramName]);
                        dateInput.classList.add('visible');
                    }
                }
            });
            
            editBoardId = id;
            modal.style.display = 'flex';
        } catch(e) {
            alert('–ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –±–æ—Ä—Ç–∞ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è.');
            console.error(e);
        }
    };

    window.deleteBoard = async (id) => {
        if (!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å –±–æ—Ä—Ç?')) return;
        await fetch(`/api/board/${id}`, { method: 'DELETE' });
        loadBoards();
    };

    // --- –û–ë–†–ê–ë–û–¢–ß–ò–ö–ò –°–û–ë–´–¢–ò–ô ---
    openModalBtn.onclick = () => {
        form.reset();
        document.querySelectorAll('.param-date-input').forEach(input => input.classList.remove('visible'));
        editBoardId = null;
        modal.style.display = 'flex';
    };

    closeModalBtn.onclick = () => { modal.style.display = 'none'; };
    window.onclick = e => { if (e.target === modal) modal.style.display = 'none'; };

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const body = {
            bpla_id: document.getElementById('bplaId').value,
            number: document.getElementById('number').value,
            supplier_id: document.getElementById('supplierId').value || null,
            engine_installation_date: document.getElementById('engine_installation_date').value || null,
            catapult_hooks_date: document.getElementById('catapult_hooks_date').value || null,
            fuel_system_date: document.getElementById('fuel_system_date').value || null,
            workshop_rods_date: document.getElementById('workshop_rods_date').value || null,
            lead_weight_date: document.getElementById('lead_weight_date').value || null,
        };
        
        // –ü—Ä–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–∏ –∏—Å–ø–æ–ª—å–∑—É–µ–º –Ω–æ–≤—ã–π, —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç
        const url = editBoardId ? `/api/workshop/${editBoardId}` : '/api/add_board';
        const method = editBoardId ? 'PUT' : 'POST';

        await fetch(url, {
            method,
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(body)
        });

        modal.style.display = 'none';
        loadBoards();
    });
    
    document.getElementById('filterForm').addEventListener('submit', (e) => { e.preventDefault(); loadBoards(); });
    document.getElementById('rodsFilter').id = 'workshopRodsFilter';
    document.getElementById('resetFilterBtn').addEventListener('click', () => { document.getElementById('filterForm').reset(); loadBoards(); });

    tableBody.addEventListener('change', async (e) => {
        if (e.target.classList.contains('table-param-checkbox')) {
            const checkbox = e.target;
            const boardId = checkbox.dataset.boardId;
            const paramName = checkbox.dataset.paramName;
            const dateToSet = checkbox.checked ? new Date().toLocaleDateString('sv-SE') : null;
            
            checkbox.disabled = true;
            const success = await updateBoardParameter(boardId, paramName, dateToSet);
            checkbox.disabled = false;

            if (success) {
                checkbox.nextElementSibling.textContent = checkbox.checked ? new Date().toLocaleDateString('ru-RU') : '';
            } else {
                checkbox.checked = !checkbox.checked;
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ—Ö—Ä–∞–Ω–∏—Ç—å –∏–∑–º–µ–Ω–µ–Ω–∏–µ.');
            }
        }
    });

    // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –°–¢–†–ê–ù–ò–¶–´ ---
    const initPage = async() => {
        const today = new Date().toLocaleDateString('sv-SE');
        document.querySelectorAll('#addModal input[type="checkbox"][data-date-target]').forEach(checkbox => {
            const dateInput = document.getElementById(checkbox.dataset.dateTarget);
            if (dateInput) {
                checkbox.addEventListener('change', () => {
                    if (checkbox.checked) {
                        dateInput.classList.add('visible');
                        if (!dateInput.value) { dateInput.value = today; }
                    } else {
                        dateInput.classList.remove('visible');
                        dateInput.value = '';
                    }
                });
            }
        });
        await loadSuppliers('supplierFilter');
        await loadSuppliers('supplierId');
        await initCommentEditor();
        await loadBplaTypesForModal(); 
        await loadBoards();
    };

    initPage();
});
</script>

</body>
</html>